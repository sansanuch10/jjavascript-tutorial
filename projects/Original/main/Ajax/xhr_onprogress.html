<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="160">AJAX и COMET</a></nav-up><h1>XMLHttpRequest: индикация прогресса</h1><p>Запрос <code>XMLHttpRequest</code> состоит из двух фаз:</p><ol><li>Стадия закачки (upload). На ней данные загружаются на сервер. Эта фаза может быть долгой для POST-запросов. Для отслеживания прогресса на стадии закачки существует объект типа <a href="https://xhr.spec.whatwg.org/#xmlhttprequesteventtarget">XMLHttpRequestUpload</a>, доступный как <code>xhr.upload</code> и события на нём.</li><li>Стадия скачивания (download). После того, как данные загружены, браузер скачивает ответ с сервера. Если он большой, то это может занять существенное время. На этой стадии используется обработчик <code>xhr.onprogress</code>.</li></ol><p>Далее – обо всём по порядку.</p><h2><a name="0" href="#0">Стадия закачки</a></h2><p>На стадии закачки для получения информации используем объект <code>xhr.upload</code>. У этого объекта нет методов, он только генерирует события в процессе закачки. А они-то как раз и нужны.</p><p>Вот полный список событий:</p><ul><li><code>loadstart</code></li><li><code>progress</code></li><li><code>abort</code></li><li><code>error</code></li><li><code>load</code></li><li><code>timeout</code></li><li><code>loadend</code></li></ul><p>Пример установки обработчиков на стадию закачки:</p><code-example><script>`xhr.upload.onprogress = function(event) {\n  alert( 'Загружено на сервер&nbsp' + event.loaded + ' байт из&nbsp' + event.total );\n}\n\nxhr.upload.onload = function() {\n  alert( 'Данные полностью загружены на сервер!' );\n}\n\nxhr.upload.onerror = function() {\n  alert( 'Произошла ошибка при загрузке данных на сервер!' );\n}`</script></code-example><h2><a name="1" href="#1">Стадия скачивания</a></h2><p>После того, как загрузка завершена, и сервер соизволит ответить на запрос, <code>XMLHttpRequest</code> начнёт скачивание ответа сервера.</p><p>На этой фазе <code>xhr.upload</code> уже не нужен, а в дело вступают обработчики событий на самом объекте <code>xhr</code>. В частности, событие <code>xhr.onprogress</code> содержит информацию о количестве принятых байт ответа.</p><p>Пример обработчика:</p><code-example><script>`xhr.onprogress = function(event) {\n  alert( 'Получено с сервера&nbsp' + event.loaded + ' байт из&nbsp' + event.total );\n}`</script></code-example><p>Все события, возникающие в этих обработчиках, имеют тип <a href="https://xhr.spec.whatwg.org/#progressevent">ProgressEvent</a>, то есть имеют свойства <code>loaded</code> – количество уже пересланных данных в байтах и <code>total</code> – общее количество данных.</p><h2><a name="2" href="#2">Демо: загрузка файла с индикатором прогресса</a></h2><p>Современный <code>XMLHttpRequest</code> позволяет отправить на сервер всё, что угодно. Текст, файл, форму.</p><p>Мы, для примера, рассмотрим загрузку файла с индикацией прогресса. Это требует от браузера поддержки <a href="http://www.w3.org/TR/FileAPI/">File API</a>, то есть исключает IE9-.</p><p>File API позволяет получить доступ к содержимому файла, который перенесён в браузер при помощи Drag’n’Drop или выбран в поле формы, и отправить его при помощи <code>XMLHttpRequest</code>.</p><p>Форма для выбора файла с обработчиком <code>submit</code>:</p><code-example><script>`<form name="upload">\n  <input type="file" name="myfile">\n  <input type="submit" value="Загрузить">\n</form>\n\n<script>\n  document.forms.upload.onsubmit = function() {\n    var input = this.elements.myfile;\n    var file = input.files[0];\n    if (file) {\nMARK      upload(file);\n    }\n    return false;\n  }\n<\/script>`</script></code-example><p>Мы получаем файл из формы через свойство <code>files</code> элемента <code>&lt;input&gt;</code> и передаём его в функцию <code>upload</code>:</p><code-example><script>`function upload(file) {\n\n  var xhr = new XMLHttpRequest();\n\n  // обработчик для закачки\n  xhr.upload.onprogress = function(event) {\n    log(event.loaded + ' /&nbsp' + event.total);\n  }\n\n  // обработчики успеха и ошибки\n  // если status == 200, то это успех, иначе ошибка\n  xhr.onload = xhr.onerror = function() {\n    if (this.status == 200) {\n      log("success");\n    } else {\n      log("error &nbsp" + this.status);\n    }\n  };\n\n  xhr.open("POST", "upload", true);\n  xhr.send(file);\n\n}`</script></code-example><p>Этот код отправит файл на сервер и будет сообщать о прогрессе при его закачке ( <code>xhr.upload.onprogress</code>), а также об окончании запроса ( <code>xhr.onload</code>, <code>xhr.onerror</code>).</p><p>Полный пример индикации прогресса при загрузке, основанный на коде выше:</p><code-tabs data-code_switch=""><tools-><code-download><a-></a-><a href="https://learn.javascript.ru/tutorial/zipview/progress.zip?plunkId=LUxvsTD9LtQJw41AJUvR" hover-style="" target="_blank" title="скачать архив"></a></code-download><button-0 class="current">index.html</button-0><button-1>server.js</button-1></tools-><code-example style="display: block;"><script>`<!DOCTYPE HTML>\n<html>\n  <head>\n    <meta charset="utf-8">\n  </head>\n<body>\n\n  <form name="upload">\n    <input type="file" name="myfile">\n    <input type="submit" value="Загрузить">\n  </form>\n\n  <div id="log">Прогресс загрузки</div>\n\n  <script>\n    function log(html) {\n      document.getElementById('log').innerHTML = html;\n    }\n\n    document.forms.upload.onsubmit = function() {\n      var file = this.elements.myfile.files[0];\n      if (file) {\n        upload(file);\n      }\n      return false;\n    }\n\n    function upload(file) {\n\n      var xhr = new XMLHttpRequest();\n\n      // обработчики можно объединить в один,\n      // если status == 200, то это успех, иначе ошибка\n      xhr.onload = xhr.onerror = function() {\n        if (this.status == 200) {\n          log("success");\n        } else {\n          log("error&nbsp" + this.status);\n        }\n      };\n\n      // обработчик для закачки\n      xhr.upload.onprogress = function(event) {\n        log(event.loaded + ' /&nbsp' + event.total);\n      }\n\n      xhr.open("POST", "upload_progress", true);\n      xhr.send(file);\n    }\n  <\/script>\n</body>\n\n</html>`</script><code-toolbar- iframe="80"><a title="показать" data-code_run="220"></a><a title="открыть в новом окне" data-new_window="code"></a><a title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example><code-example style=""><script>`var http = require('http');\nvar url = require('url');\nvar querystring = require('querystring');\nvar static = require('node-static');\nvar file = new static.Server('.', {\n  cache: 0\n});\n\nfunction accept(req, res) {\n\n  if (req.url == '/upload_progress') {\n    var length = 0;\n    req.on('data', function(chunk) {\n      // ничего не делаем с приходящими данными, просто считываем\n      length += chunk.length;\n      if (length > 50 * 1024 * 1024) {\n        res.statusCode = 413;\n        res.end("File too big");\n      }\n    }).on('end', function() {\n      res.end('ok');\n    });\n\n  } else {\n    file.serve(req, res);\n  }\n}\n\n// ------ запустить сервер -------\n\nif (!module.parent) {\n  http.createServer(accept).listen(8080);\n} else {\n  exports.accept = accept;\n}`</script></code-example></code-tabs><h2><a name="3" href="#3">Событие onprogress в деталях</a></h2><p>При обработке события <code>onprogress</code> есть ряд важных тонкостей.</p><p>Можно, конечно, их игнорировать, но лучше бы знать.</p><p>Заметим, что событие, возникающее при <code>onprogress</code>, имеет одинаковый вид на стадии закачки (в обработчике <code>xhr.upload.onprogress</code>) и при получении ответа (в обработчике <code>xhr.onprogress</code>).</p><p>Оно представляет собой объект типа <a href="https://xhr.spec.whatwg.org/#progressevent">ProgressEvent</a> со свойствами:</p><dl><dt><code>loaded</code></dt><dd><p>Сколько байт уже переслано.</p><p>Имеется в виду только тело запроса, заголовки не учитываются.</p></dd><dt><code>lengthComputable</code></dt><dd><p>Если <code>true</code>, то известно полное количество байт для пересылки, и оно хранится в свойстве <code>total</code>.</p></dd><dt><code>total</code></dt><dd><p>Общее количество байт для пересылки, если известно.</p><p>А может ли оно быть неизвестно?</p></dd></dl><ul><li>При закачке на сервер браузер всегда знает полный размер пересылаемых данных, так что <code>total</code> всегда содержит конкретное количество байт, а значение <code>lengthComputable</code> всегда будет <code>true</code>.</li><li>При скачивании данных – обычно сервер в начале сообщает их общее количество в HTTP-заголовке <code>Content-Length</code>. Но он может и не делать этого, например если сам не знает, сколько данных будет или если генерирует их динамически. Тогда <code>total</code> будет равно <code>0</code>. А чтобы отличить нулевой размер данных от неизвестного – как раз служит <code>lengthComputable</code>, которое в данном случае равно <code>false</code>.</li></ul><p>Ещё особенности, которые необходимо учитывать при использовании <code>onprogress</code>:</p><ul><li><p><strong>Событие происходит при каждом полученном/отправленном байте, но не чаще чем раз в 50 мс.</strong></p><p>Это обозначено в <a href="http://www.w3.org/TR/XMLHttpRequest/#make-progress-notifications">спецификации progress notifications</a>.</p></li><li><p><strong>В процессе получения данных, ещё до их полной передачи, доступен <code>xhr.responseText</code>, но он не обязательно содержит корректную строку.</strong></p><p>Можно до окончания запроса заглянуть в него и прочитать текущие полученные данные. Важно, что при пересылке строки в кодировке UTF-8 кириллические символы, как, впрочем, и многие другие, кодируются 2 байтами. Возможно, что в конце одного пакета данных окажется первая половинка символа, а в начале следующего – вторая. Поэтому полагаться на то, что до окончания запроса в <code>responseText</code> находится корректная строка нельзя. Она может быть обрезана посередине символа.</p><p>Исключение – заведомо однобайтные символы, например цифры или латиница.</p></li><li><p><strong>Сработавшее событие <code>xhr.upload.onprogress</code> не гарантирует, что данные дошли.</strong></p><p>Событие <code>xhr.upload.onprogress</code> срабатывает, когда данные отправлены браузером. Но оно не гарантирует, что сервер получил, обработал и записал данные на диск. Он говорит лишь о самом факте отправки.</p><p>Поэтому прогресс-индикатор, получаемый при его помощи, носит приблизительный и оптимистичный характер.</p></li></ul><h2><a name="4" href="#4">Файлы и формы</a></h2><p>Выше мы использовали <code>xhr.send(file)</code> для передачи файла непосредственно в теле запроса.</p><p>При этом посылается только <em>содержимое</em> файла.</p><p>Если нужно дополнительно передать имя файла или что-то ещё – это можно удобно сделать через форму, при помощи объекта <a href="https://developer.mozilla.org/en-US/docs/DOM/XMLHttpRequest/FormData/Using_FormData_Objects">FormData</a>:</p><p>Создадим форму <code>formData</code> и прибавим к ней поле с файлом <code>file</code> и именем <code>"myfile"</code>:</p><code-example><script>`var formData = new FormData();\nformData.append("myfile", file);\nxhr.send(formData);`</script></code-example><p>Данные будут отправлены в кодировке <code>multipart/form-data</code>. Серверный фреймворк увидит это как обычную форму с файлом, практически все серверные технологии имеют их встроенную поддержку. Индикация прогресса реализуется точно так же.</p><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>! function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||screen.width<1024||"bannerBottomDisabled" in localStorage||(localStorage.bannerBottomShownCount||(localStorage.bannerBottomShownCount=1),document.querySelector(".banner-bottom").style.display="block")}();</script><nav-book data-tooltips="XMLHttpRequest: кросс-доменные запросы; XMLHttpRequest: возобновляемая закачка"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url="https:\/\/learn.javascript.ru\/xhr-onprogress",disqus_identifier="xhr-onprogress",disqus_title="XMLHttpRequest: \u0438\u043d\u0434\u0438\u043a\u0430\u0446\u0438\u044f \u043f\u0440\u043e\u0433\u0440\u0435\u0441\u0441\u0430";</script></page-content></main>