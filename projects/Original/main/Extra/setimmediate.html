<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="234">О всякой всячине</a></nav-up><h1>Асинхронное выполнение: setImmediate</h1><p>Функция, отложенная через <code>setTimeout(..0)</code> выполнится не ранее следующего «тика» таймера, минимальная частота которого может составлять от 4 до 1000 мс. И, конечно же, это произойдёт после того, как все текущие изменения будут перерисованы.</p><p>Но нужна ли нам эта дополнительная задержка? Как правило, используя <code>setTimeout(func, 0)</code>, мы хотим перенести выполнение <code>func</code> на «ближайшее время после текущего кода», и какая-то дополнительная задержка нам не нужна. Если бы была нужна – мы бы её указали вторым аргументом вместо <code>0</code>.</p><h2><a name="0" href="#0">Метод setImmediate(func)</a></h2><p>Для того, чтобы поставить функцию в очередь на выполнение без задержки, в Microsoft предложили метод <a href="http://msdn.microsoft.com/en-us/library/ie/hh773176.aspx">setImmediate(func)</a>. Он реализован в IE10+ и на платформе Node.JS.</p><p>У <code>setImmediate</code> единственный аргумент – это функция, выполнение которой нужно запланировать.</p><p>В других браузерах <code>setImmediate</code> нет, но его можно эмулировать, используя, к примеру, метод <a href="https://developer.mozilla.org/en-US/docs/DOM/window.postMessage">postMessage</a>, предназначенный для пересылки сообщений от одного окна другому. Детали работы с <code>postMessage</code> вы найдёте в статье <a href="/cross-window-messaging-with-postmessage">Общение окон с разных доменов: postMessage</a>. Желательно читать её после освоения темы «События».</p><p>Полифилл для <code>setImmediate</code> через <code>postMessage</code>:</p><code-example><script>`if (!window.setImmediate) window.setImmediate = (function() {\n  var head = { }, tail = head; // очередь вызовов, 1-связный список\n\n  var ID = Math.random(); // уникальный идентификатор\n\n  function onmessage(e) {\n    if(e.data != ID) return; // не наше сообщение\n    head = head.next;\n    var func = head.func;\n    delete head.func;\n    func();\n  }\n\n  if(window.addEventListener) { // IE9+, другие браузеры\n    window.addEventListener('message', onmessage);\n  } else { // IE8\n    window.attachEvent( 'onmessage', onmessage );\n  }\n\n  return function(func) {\n    tail = tail.next = { func: func };\n    window.postMessage(ID, "*");\n  };\n}());`</script></code-example><p>Есть и более сложные эмуляции, включая <a href="http://www.w3.org/TR/webmessaging/#channel-messaging">MessageChannel</a> для работы с <a href="http://www.w3.org/TR/workers/">Web Workers</a> и хитрый метод для поддержки IE8-: <a href="https://github.com/NobleJS/setImmediate">https://github.com/NobleJS/setImmediate</a>. Все они по существу являются «хаками», направленными на то, чтобы обеспечить поддержку <code>setImmediate</code> в тех браузерах, где его нет.</p><h2><a name="1" href="#1">Тест производительности</a></h2><p>Чтобы сравнить реальную частоту срабатывания – измерим время на 100 последовательных вызовов при <code>setTimeout(..0)</code> по сравнению с <code>setImmediate</code>:</p><code-tabs data-code_switch=""><tools-><button-0 class="current">index.html</button-0><button-1>setImmediate.js</button-1></tools-><code-example style="display: block;"><script src="index_setImmediate.html">`<!DOCTYPE HTML>\n<html>\n\n<head>\n  <meta charset="UTF-8">\n  <meta http-equiv="X-UA-Compatible" content="IE=edge">\n  <script src="setImmediate.js"><\/script>\n</head>\n\n<body>\n\n  <button onclick="testTimeout()">testTimeout</button>\n  <button onclick="testImmediate()">testImmediate</button>\n\n  <script>\n    function testTimeout() {\n      var start = new Date();\n      var i = 0;\n      setTimeout(function go() {\n        i++;\n        if (i == 100) {\n          alert(new Date - start);\n        } else {\n          setTimeout(go, 0);\n        }\n      }, 0);\n    }\n\n    function testImmediate() {\n      var start = new Date();\n      var i = 0;\n      setImmediate(function go() {\n        i++;\n        if (i == 100) {\n          alert(new Date - start);\n        } else {\n          setImmediate(go);\n        }\n      });\n    }\n  <\/script>\n\n</body>\n\n</html>`</script><code-toolbar- iframe="100"><a data-code_run="200" title="показать"></a><a title="открыть в новом окне" data-new_window="code"></a><a title="редактировать в песочнице" data-code_edit=""></a></code-toolbar-></code-example><code-example><script>`if (!window.setImmediate) window.setImmediate = (function() {\n  var head = {},\n    tail = head; // очередь вызовов, 1-связный список\n\n  var ID = Math.random(); // уникальный идентификатор\n\n  function onmessage(e) {\n    if (e.data != ID) return; // не наше сообщение\n    head = head.next;\n    var func = head.func;\n    delete head.func;\n    func();\n  }\n\n  if (window.addEventListener) { // IE9+, другие браузеры\n    window.addEventListener('message', onmessage);\n  } else { // IE8\n    window.attachEvent('onmessage', onmessage);\n  }\n\n  return function(func) {\n    tail = tail.next = {\n      func: func\n    };\n    window.postMessage(ID, "*");\n  };\n}());`</script></code-example></code-tabs><p>Запустите пример выше – и вы увидите реальную разницу во времени между <code>setTimeout(.., 0)</code> и <code>setImmediate</code>. Да, она может быть более в 50, 100 и более раз.</p><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>! function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||screen.width<1024||"bannerBottomDisabled" in localStorage||(localStorage.bannerBottomShownCount||(localStorage.bannerBottomShownCount=1),document.querySelector(".banner-bottom").style.display="block")}();</script><nav-book data-tooltips="Книги по JS, HTML/CSS и не только; Позднее связывание 'bindLate'"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url="https:\/\/learn.javascript.ru\/setimmediate",disqus_identifier="setimmediate",disqus_title="\u0410\u0441\u0438\u043d\u0445\u0440\u043e\u043d\u043d\u043e\u0435 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435: setImmediate";</script></page-content></main>