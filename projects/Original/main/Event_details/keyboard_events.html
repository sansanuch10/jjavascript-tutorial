<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="98">Документ, события, интерфейсы</a><arrow-next></arrow-next><a data-load_page="128">События в деталях</a></nav-up><h1>Клавиатура: keyup, keydown, keypress</h1><p>Здесь мы рассмотрим основные «клавиатурные» события и работу с ними.</p><h2><a name="0" href="#0">Тестовый стенд</a></h2><p>Для того, чтобы лучше понять, как работают события клавиатуры, можно использовать тестовый стенд.</p><p>Попробуйте различные варианты нажатия клавиш в текстовом поле.</p><code-tabs data-code_switch=""><tools-><button-0 class="current">keyboard.html</button-0><button-1>keyboard.js</button-1><button-2>keyboard.css</button-2></tools-><code-example style="display: block;"><script>`<!DOCTYPE HTML>\n<html>\n<head>\n  <meta charset="utf-8">\n   <style>\n    GOLD_#kinput_GOLD {\n      font-size: 150%;\n      box-sizing: border-box;\n      width: 95%;\n    }\n    \n    GOLD_#area_GOLD {\n      width: 95%;\n      box-sizing: border-box;\n      height: 250px;\n      border: 1px solid black;\n      display: block;\n    }\n    \n    GOLD_form label_GOLD {\n      display: inline;\n      white-space: nowrap;\n    }\n   </style>\n</head>\n\n<body style="padding:20px">\n  <form id="form" onsubmit="return false">\n    Предотвратить действие по умолчанию для:\n    <label>\n      <input type="checkbox" name="keydownStop" value="1"> keydown</label>&nbsp;&nbsp;&nbsp;\n    <label>\n      <input type="checkbox" name="keypressStop" value="1"> keypress</label>&nbsp;&nbsp;&nbsp;\n    <label>\n      <input type="checkbox" name="keyupStop" value="1"> keyup</label>\n    <p>\n      Игнорировать:\n      <label>\n        <input type="checkbox" name="keydownIgnore" value="1"> keydown</label>&nbsp;&nbsp;&nbsp;\n      <label>\n        <input type="checkbox" name="keypressIgnore" value="1"> keypress</label>&nbsp;&nbsp;&nbsp;\n      <label>\n        <input type="checkbox" name="keyupIgnore" value="1"> keyup</label>\n    </p>\n\n    <p>Сфокусируйтесь на поле и нажмите какую-нибудь клавишу.</p>\n\n    <input type="text" placeholder="Клавиши нажимать тут" id="kinput">\n\n    <textarea id="area"></textarea>\n    <input type="button" value="Очистить" onclick="area.value=''" />\n  </form>\n\n  <script>\n    kinput.onkeydown = kinput.onkeyup = kinput.onkeypress = handle;\n    var lastTime = Date.now();\n    function handle(e) {\n      if (form.elements[e.type + 'Ignore'].checked) return;\n      var text = e.type +\n        ' GREEN_keyCode=_GREEN' + e.keyCode +\n        ' GREEN_which=_GREEN' + e.which +\n        ' GREEN_charCode=_GREEN' + e.charCode +\n        ' GREEN_char=_GREEN' + String.fromCharCode(e.keyCode || e.charCode) +\n        (e.shiftKey ? ' +shift' : '') +\n        (e.ctrlKey ? ' +ctrl' : '') +\n        (e.altKey ? ' +alt' : '') +\n        (e.metaKey ? ' +meta' : '') + "\\n";\n      if (area.value && Date.now() - lastTime > 250) {\n        area.value += new Array(81).join('-') + '\\n';\n      }\n      lastTime = Date.now();\n      area.value += text;\n      area.scrollTop = area.scrollHeight;\n      if (form.elements[e.type + 'Stop'].checked) {\n        e.preventDefault();\n      }\n    }\n  <\/script>\n  \n</body>\n</html>`</script><code-toolbar- iframe="470"><a title="показать" data-code_run="0"></a><a title="открыть в новом окне" data-new_window="code"></a><a title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example><code-example><script>`kinput.onkeydown = kinput.onkeyup = kinput.onkeypress = handle;\n\nvar lastTime = Date.now();\n\nfunction handle(e) {\n  if (form.elements[e.type + 'Ignore'].checked) return;\n\n  var text = e.type +\n    ' GREEN_keyCode=_GREEN' + e.keyCode +\n    ' GREEN_which=_GREEN' + e.which +\n    ' GREEN_charCode=_GREEN' + e.charCode +\n    ' GREEN_char=_GREEN' + String.fromCharCode(e.keyCode || e.charCode) +\n    (e.shiftKey ? ' +shift' : '') +\n    (e.ctrlKey ? ' +ctrl' : '') +\n    (e.altKey ? ' +alt' : '') +\n    (e.metaKey ? ' +meta' : '') + "\\n";\n\n  if (area.value && Date.now() - lastTime > 250) {\n    area.value += new Array(81).join('-') + '\\n';\n  }\n  lastTime = Date.now();\n\n  area.value += text;\n\n  area.scrollTop = area.scrollHeight;\n\n  if (form.elements[e.type + 'Stop'].checked) {\n    e.preventDefault();\n  }\n}`</script><code-toolbar- iframe="450"><div></div><a title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example><code-example><script>`GOLD_#kinput_GOLD {\n  font-size: 150%;\n  box-sizing: border-box;\n  width: 95%;\n}\n\nGOLD_#area_GOLD {\n  width: 95%;\n  box-sizing: border-box;\n  height: 250px;\n  border: 1px solid black;\n  display: block;\n}\n\nGOLD_form label_GOLD {\n  display: inline;\n  white-space: nowrap;\n}`</script></code-example><code-example><script>`<!DOCTYPE HTML>\n<html>\n<head>\n  <meta charset="utf-8">\n   <style>\n    GOLD_#kinput_GOLD {\n      font-size: 150%;\n      box-sizing: border-box;\n      width: 95%;\n    }\n    \n    GOLD_#area_GOLD {\n      width: 95%;\n      box-sizing: border-box;\n      height: 250px;\n      border: 1px solid black;\n      display: block;\n    }\n    \n    GOLD_form label_GOLD {\n      display: inline;\n      white-space: nowrap;\n    }\n   </style>\n</head>\n\n<body>\n  <form id="form" onsubmit="return false">\n    Предотвратить действие по умолчанию для:\n    <label>\n      <input type="checkbox" name="keydownStop" value="1"> keydown</label>&nbsp;&nbsp;&nbsp;\n    <label>\n      <input type="checkbox" name="keypressStop" value="1"> keypress</label>&nbsp;&nbsp;&nbsp;\n    <label>\n      <input type="checkbox" name="keyupStop" value="1"> keyup</label>\n    <p>\n      Игнорировать:\n      <label>\n        <input type="checkbox" name="keydownIgnore" value="1"> keydown</label>&nbsp;&nbsp;&nbsp;\n      <label>\n        <input type="checkbox" name="keypressIgnore" value="1"> keypress</label>&nbsp;&nbsp;&nbsp;\n      <label>\n        <input type="checkbox" name="keyupIgnore" value="1"> keyup</label>\n    </p>\n\n    <p>Сфокусируйтесь на поле и нажмите какую-нибудь клавишу.</p>\n\n    <input type="text" placeholder="Клавиши нажимать тут" id="kinput">\n\n    <textarea id="area"></textarea>\n    <input type="button" value="Очистить" onclick="area.value=''" />\n  </form>\n\n  <script>\n    kinput.onkeydown = kinput.onkeyup = kinput.onkeypress = handle;\n    var lastTime = Date.now();\n    function handle(e) {\n      if (form.elements[e.type + 'Ignore'].checked) return;\n      var text = e.type +\n        ' GREEN_keyCode=_GREEN' + e.keyCode +\n        ' GREEN_which=_GREEN' + e.which +\n        ' GREEN_charCode=_GREEN' + e.charCode +\n        ' GREEN_char=_GREEN' + String.fromCharCode(e.keyCode || e.charCode) +\n        (e.shiftKey ? ' +shift' : '') +\n        (e.ctrlKey ? ' +ctrl' : '') +\n        (e.altKey ? ' +alt' : '') +\n        (e.metaKey ? ' +meta' : '') + "\\n";\n      if (area.value && Date.now() - lastTime > 250) {\n        area.value += new Array(81).join('-') + '\\n';\n      }\n      lastTime = Date.now();\n      area.value += text;\n      area.scrollTop = area.scrollHeight;\n      if (form.elements[e.type + 'Stop'].checked) {\n        e.preventDefault();\n      }\n    }\n  <\/script>\n  \n</body>\n</html>`</script><code-toolbar- iframe="450"><a title="показать" data-code_run="0"></a><a title="открыть в новом окне" data-new_window="code"></a><a title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example></code-tabs><p>По мере чтения, если возникнут вопросы – возвращайтесь к этому стенду.</p><h2><a name="1" href="#1">События keydown и keyup</a></h2><p>События <code>keydown/keyup</code> происходят при нажатии/отпускании клавиши и позволяют получить её <em>скан-код</em> в свойстве <code>keyCode</code>.</p><p>Скан-код клавиши одинаков в любой раскладке и в любом регистре. Например, клавиша <kbd class="shortcut">z</kbd> может означать символ <code>"z"</code>, <code>"Z"</code> или <code>"я"</code>, <code>"Я"</code> в русской раскладке, но её <em>скан-код</em> будет всегда одинаков: <code>90</code>.</p><p>В действии:</p><code-example><script>`<input onkeydown="this.nextSibling.innerHTML = ' ' + event.keyCode"\n  onkeyup="setTimeout(()=>{this.value=''; this.nextElementSibling.innerHTML=''},2000)">\n<b></b>`</script></code-example><p><input size="40" placeholder="Нажмите клавишу, скан-код будет справа" onkeydown="this.nextElementSibling.innerHTML = event.keyCode;event.stopImmediatePropagation();" onkeyup="setTimeout(()=>{this.value = '';this.nextElementSibling.innerHTML = ''},2000)">&nbsp;<b></b></p><h3><a name="10" href="#10">Скан-коды</a></h3><p>Для буквенно-цифровых клавиш есть очень простое правило: скан-код будет равен коду соответствующей заглавной английской буквы/цифры.</p><p>Например, при нажатии клавиши <kbd class="shortcut">S</kbd> (не важно, каков регистр и раскладка) её скан-код будет равен <code>"S".charCodeAt(0)</code>.</p><p>Для других символов, в частности, знаков пунктуации, есть таблица кодов, которую можно взять, например, из статьи Джона Уолтера: <a href="http://unixpapa.com/js/key.html">JavaScript Madness: Keyboard Events</a>, или же можно нажать на нужную клавишу на <a href="#0">тестовом стенде</a> и получить код.</p><p>Когда-то в этих кодах была масса кросс-браузерных несовместимостей. Сейчас всё проще – таблицы кодов в различных браузерах почти полностью совпадают. Но некоторые несовместимости, всё же, остались. Вы можете увидеть их в таблице ниже. Слева – клавиша с символом, а справа – скан-коды в различных браузерах.</p><p>Таблица несовместимостей:</p><table><thead><tr><th>Клавиша</th><th>Firefox</th><th>Остальные браузеры</th></tr></thead><tbody><tr><td><kbd class="shortcut">;</kbd></td><td>59</td><td>186</td></tr><tr><td><kbd class="shortcut">=</kbd></td><td>107</td><td>187</td></tr><tr><td><kbd class="shortcut">-</kbd></td><td>109</td><td>188</td></tr></tbody></table><p>Остальные коды одинаковы, код для нужного символа будет в тестовом стенде.</p><h2><a name="2" href="#2">Событие keypress</a></h2><p>Событие <code>keypress</code> возникает сразу после <code>keydown</code>, если нажата <em>символьная</em> клавиша, т.е. нажатие приводит к появлению символа.</p><p>Любые буквы, цифры генерируют <code>keypress</code>. Управляющие клавиши, такие как <kbd class="shortcut">Ctrl</kbd>, <kbd class="shortcut">Shift</kbd>, <kbd class="shortcut">F1</kbd>, <kbd class="shortcut">F2</kbd>… – <code>keypress</code> не генерируют.</p><p>Событие <code>keypress</code> позволяет получить <em>код символа</em>. В отличие от скан-кода, он специфичен именно для символа и различен для <code>"z"</code> и <code>"я"</code>.</p><p>Код символа хранится в свойствах: <code>charCode</code> и <code>which</code>. Здесь скрывается целое «гнездо» кросс-браузерных несовместимостей, разбираться с которыми нет никакого смысла – запомнить сложно, а на практике нужна лишь одна «правильная» функция, позволяющая получить код везде.</p><h3><a name="11" href="#11">Получение символа в keypress</a></h3><p>Кросс-браузерная функция для получения символа из события <code>keypress</code>:</p><code-example><script>`// event.type должен быть keypress\nfunction getChar(event) {\n  if (event.which == null) { // IE\n    if (event.keyCode < 32) return null; // спец. символ\n    return String.fromCharCode(event.keyCode)\n  }\n\n  if (event.which != 0 && event.charCode != 0) { // все кроме IE\n    if (event.which < 32) return null; // спец. символ\n    return String.fromCharCode(event.which); // остальные\n  }\n\n  return null; // спец. символ\n}`</script></code-example><p>Для общей информации – вот основные браузерные особенности, учтённые в <code>getChar(event)</code>:</p><ol><li>Во всех браузерах, кроме IE, у события <code>keypress</code> есть свойство <code>charCode</code>, которое содержит код символа.</li><li>Браузер IE для <code>keypress</code> не устанавливает <code>charCode</code>, а вместо этого он записывает код символа в <code>keyCode</code> (в <code>keydown/keyup</code> там хранится скан-код).</li><li>Также в функции выше используется проверка <code>if(event.which!=0)</code>, а не более короткая <code>if(event.which)</code>. Это не случайно! При <code>event.which=null</code> первое сравнение даст <code>true</code>, а второе – <code>false</code>.</li></ol><p>В действии:</p><code-example><script>`<input onkeydown="this.nextSibling.innerHTML = ' ' + getChar(event)"\n  onkeyup="setTimeout(()=>{this.value=''; this.nextElementSibling.innerHTML=''},2000)">\n<b></b>`</script></code-example><p><input size="40" placeholder="Наберите символ, он будет справа" onkeypress="this.nextElementSibling.innerHTML = ' '+getChar(event)" onkeyup="setTimeout(()=>{this.value = '';this.nextElementSibling.innerHTML = ''},2000)"><b></b></p><important-warn><h3>Неправильный <code>getChar</code></h3><p>В сети вы можете найти другую функцию того же назначения:</p><code-example><script>`function getChar(event) {\n  return String.fromCharCode(event.keyCode || event.charCode);\n}`</script></code-example><p>Она работает неверно для многих специальных клавиш, потому что не фильтрует их. Например, она возвращает символ амперсанда <code>"&amp;"</code>, когда нажата клавиша „Стрелка Вверх“. Лучше использовать ту, что приведена выше.</p></important-warn><p>Как и у других событий, связанных с пользовательским вводом, поддерживаются свойства <code>shiftKey</code>, <code>ctrlKey</code>, <code>altKey</code> и <code>metaKey</code>.</p><p>Они установлены в <code>true</code>, если нажаты клавиши-модификаторы – соответственно, <kbd class="shortcut">Shift</kbd>, <kbd class="shortcut">Ctrl</kbd>, <kbd class="shortcut">Alt</kbd> и <kbd class="shortcut">Cmd</kbd> для Mac.</p><h2><a name="3" href="#3">Отмена пользовательского ввода</a></h2><p>Появление символа можно предотвратить, если отменить действие браузера на <code>keydown/keypress</code>:</p><code-example><script>`Попробуйте что-нибудь ввести в этих полях:\n<input HIGHonkeydown="return false"LIGHT type="text" size="30">\n<input HIGHonkeypress="return false"LIGHT type="text" size="30">`</script></code-example><p>Попробуйте что-нибудь ввести в этих полях (не получится):</p><input onkeydown="return false" type="text" size="30">&nbsp;<input onkeypress="return false" type="text" size="30"><p>При тестировании на стенде вы можете заметить, что отмена действия браузера при <code>keydown</code> также предотвращает само событие <code>keypress</code>.</p><important-warn><h3>При <code>keydown/keypress</code> значение ещё старое</h3><p>На момент срабатывания <code>keydown/keypress</code><em>клавиша ещё не обработана браузером</em>.</p><p>Поэтому в обработчике значение <code>input.value</code> – старое, т.е. до ввода. Это можно увидеть в примере ниже. Вводите символы <code>abcd..</code>, а справа будет текущее <code>input.value</code>: <code>abc..</code></p><p><input onkeydown="this.nextSibling.innerHTML=this.value" type="text" placeholder="Вводите символы" onkeyup="setTimeout(()=>{this.value = '';this.nextElementSibling.innerHTML = ''},3000)"><b></b></p><p>А что, если мы хотим обработать <code>input.value</code> именно после ввода? Самое простое решение – использовать событие <code>keyup</code>, либо запланировать обработчик через <code>setTimeout(..,0)</code>.</p></important-warn><h3><a name="12" href="#12">Отмена любых действий</a></h3><p>Отменять можно не только символ, а любое действие клавиш.</p><p>Например:</p><ul><li>При отмене <kbd class="shortcut">Backspace</kbd> – символ не удалится.</li><li>При отмене <kbd class="shortcut">PageDown</kbd> – страница не прокрутится.</li><li>При отмене <kbd class="shortcut">Tab</kbd> – курсор не перейдёт на следующее поле.</li></ul><p>Конечно же, есть действия, которые в принципе нельзя отменить, в первую очередь – те, которые происходят на уровне операционной системы. Комбинация Alt+F4 инициирует закрытие браузера в Windows, что бы мы ни делали в JavaScript.</p><h3><a name="13" href="#13">Демо: перевод символа в верхний регистр</a></h3><p>В примере ниже действие браузера отменяется с помощью <code>return false</code>, а вместо него в <code>input</code> добавляется значение в верхнем регистре:</p><code-example><script>`<input id="only-upper" type="text" size="2">\n<script>\n  document.getElementById('only-upper').onkeypress = function(e) {\n    // спец. сочетание - не обрабатываем\n    if (e.ctrlKey || e.altKey || e.metaKey) return;\n\n    var char = getChar(e);\n\n    if (!char) return; // спец. символ - не обрабатываем\n\n    this.value = char.toUpperCase();\n\n    return false;\n  };\n\n  function getChar(event) {\n    if (event.which == null) {\n      if (event.keyCode < 32) return null;\n      return String.fromCharCode(event.keyCode) // IE\n    }\n\n    if (event.which != 0 && event.charCode != 0) {\n      if (event.which < 32) return null;\n      return String.fromCharCode(event.which) // остальные\n    }\n\n    return null;\n  }\n<\/script>`</script><code-toolbar- iframe="80"><a data-code_run="250" title="показать"></a><div></div></code-toolbar-></code-example><h2><a name="4" href="#4">Несовместимости</a></h2><p>Некоторые несовместимости в порядке срабатывания клавиатурных событий (когда что) ещё существуют.</p><p>Стоит иметь в виду три основных категории клавиш, работа с которыми отличается.</p><table><thead><tr><th>Категория</th><th>События</th><th>Описание</th></tr></thead><tbody><tr><td>Печатные клавиши <code>S</code><code>1</code><code>,</code></td><td><code>keydown</code><br><code>keypress</code><br><code>keyup</code></td><td>Нажатие вызывает <code>keydown</code> и <code>keypress</code>.Когда клавишу отпускают, срабатывает <code>keyup</code>.<p>Исключение – CapsLock под MacOS, с ним есть проблемы:</p><ul><li>В Safari/Chrome/Opera: при включении только <code>keydown</code>, при отключении только <code>keyup</code>.</li><li>В Firefox: при включении и отключении только <code>keydown</code>.</li></ul></td></tr><tr><td>Специальные клавиши <code>Alt</code><code>Esc</code><code>⇧</code></td><td><code>keydown</code><code>keyup</code></td><td>Нажатие вызывает <code>keydown</code>.Когда клавишу отпускают, срабатывает <code>keyup</code>.<p>Некоторые браузеры могут дополнительно генерировать и <code>keypress</code>, например IE для <code>Esc</code>.</p><p>На практике это не доставляет проблем, так как для специальных клавиш мы всегда используем <code>keydown/keyup</code>.</p></td></tr><tr><td>Сочетания с печатной клавишей <code>Alt+E</code><br><code>Ctrl+У</code><br><code>Cmd+1</code><br></td><td><code>keydown</code><br><code>keypress?</code><br><code>keyup</code></td><td><p>Браузеры под Windows – не генерируют <code>keypress</code>, браузеры под MacOS – генерируют.</p><p>Кроме того, если сочетание вызвало браузерное действие или диалог ("Сохранить файл", "Открыть" и т.п., ряд диалогов можно отменить при <code>keydown</code>), то может быть только <code>keydown</code>.</p></td></tr></tbody></table><p>Общий вывод можно сделать такой:</p><ul><li>Обычные символы работают везде корректно.</li><li>CapsLock под MacOS ведёт себя плохо, не стоит ставить на него обработчики вообще.</li><li>Для других специальных клавиш и сочетаний с ними следует использовать только <code>keydown</code>.</li></ul><h2><a name="5" href="#5">Автоповтор</a></h2><p>При долгом нажатии клавиши возникает <em>автоповтор</em>. По стандарту, должны генерироваться многократные события <code>keydown (+keypress)</code>, и вдобавок стоять свойство <a href="http://www.w3.org/TR/DOM-Level-3-Events/#events-KeyboardEvent-repeat">repeat=true</a> у объекта события.</p><p>То есть поток событий должен быть такой:</p><code-example><script>`keydown\nkeypress\nkeydown\nkeypress\n..повторяется, пока клавиша не отжата...\nkeyup`</script></code-example><p>Однако в реальности на это полагаться нельзя. На момент написания статьи, под Firefox(Linux) генерируется и <code>keyup</code>:</p><code-example><script>`keydown\nkeypress\nkeyup\nkeydown\nkeypress\nkeyup\n..повторяется, пока клавиша не отжата...\nkeyup`</script></code-example><p>…А Chrome под MacOS не генерирует <code>keypress</code>. В общем, «зоопарк».</p><p>Полагаться можно только на <code>keydown</code> при каждом автонажатии и <code>keyup</code> по отпусканию клавиши.</p><h2><a name="6" href="#6">Итого</a></h2><p>Ряд рецептов по итогу этой главы:</p><ol><li>Для реализации горячих клавиш, включая сочетания – используем <code>keydown</code>. Скан-код будет в <code>keyCode</code>, почти все скан-коды кросс-браузерны, кроме нескольких пунктуационных, перечисленных в таблице выше.</li><li>Если нужен именно символ – используем <code>keypress</code>. При этом функция <code>getChar</code> позволит получить символ и отфильтровать лишние срабатывания. Гарантированно получать символ можно только при нажатии обычных клавиш, если речь о сочетаниях с модификаторами, то <code>keypress</code> не всегда генерируется.</li><li>Ловля CapsLock глючит под MacOS. Её можно организовать при помощи проверки <code>navigator.userAgent</code> и <code>navigator.platform</code>, а лучше вообще не трогать эту клавишу.</li></ol><p>Распространённая ошибка – использовать события клавиатуры для работы с полями ввода в формах.</p><p>Это нежелательно. События клавиатуры предназначены именно для работы с клавиатурой. Да, их можно использовать для проверки ввода в <code>&lt;input&gt;</code>, но будут недочёты. Например, текст может быть вставлен мышкой, при помощи правого клика и меню, без единого нажатия клавиши. И как нам помогут события клавиатуры?</p><p>Некоторые мобильные устройства также не генерируют <code>keypress/keydown</code>, а сразу вставляют текст в поле. Обработать ввод на них при помощи клавиатурных событий нельзя.</p><p>Далее мы разберём <a data-load_page="143">события для элементов форм</a>, которые позволяют работать с вводом в формы правильно.</p><p>Их можно использовать как отдельно от событий клавиатуры, так и вместе с ними.</p><h2 id="tasks"><a href="#7" name="7">Задачи (2)</a></h2><task-content><h3><a href="#14" name="14">Поле только для цифр</a><task-open hover-style="" data-show_task="" title="Открыть задачу"></task-open></h3><span title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span><p>При помощи событий клавиатуры сделайте так, чтобы в поле можно было вводить только цифры. Пример ниже.</p><code-result><iframe id="number_only" style="height: 100px;" src="iframe.html"></iframe><script>setTimeout(() =>{run_1.click();number_only.src=number_only.getAttribute('src');},100);</script></code-result><p>В поле должны нормально работать специальные клавиши <kbd class="shortcut">Delete</kbd>/<kbd class="shortcut">Backspace</kbd> и сочетания с <kbd class="shortcut">Ctrl</kbd>/<kbd class="shortcut">Alt</kbd>/<kbd class="shortcut">Cmd</kbd>.</p><p>P.S. Конечно, при помощи альтернативных способов ввода (например, вставки мышью), посетитель всё же может ввести что угодно.</p><p><a data-click="task_1">Открыть песочницу для задачи.</a></p><button-answer data-toggle_answer="" style="">решение</button-answer><task-answer-ext><button-answer-ext data-toggle_answer_ext="" style="">Подсказка: выбор события</button-answer-ext><task-answer><close- title="закрыть" data-close_answer=""></close-><h4>Подсказка: выбор события</h4><p>Нам нужно событие <code>keypress</code>, так как по скан-коду мы не отличим, например, клавишу <code>'2'</code> обычную и в верхнем регистре (символ <code>'@'</code>).</p><p>Нужно отменять действие по умолчанию (т.е. ввод), если введена не цифра.</p></task-answer><button-answer-ext data-toggle_answer_ext="" style="">Решение</button-answer-ext><task-answer><close- title="закрыть" data-close_answer=""></close-><h4>Решение</h4><p>Нам нужно проверять <em>символы</em> при вводе, поэтому, будем использовать событие <code>keypress</code>.</p><p>Алгоритм такой: получаем символ и проверяем, является ли он цифрой. Если не является, то отменяем действие по умолчанию.</p><p>Кроме того, игнорируем специальные символы и нажатия со включенным <kbd class="shortcut">Ctrl</kbd>/<kbd class="shortcut">Alt</kbd>/<kbd class="shortcut">Cmd</kbd>.</p><p>Итак, вот решение:</p><code-example><script>`Введите ваш возраст:\n<input type="text">\n\n<script>\n  document.getElementsByTagName('input')[0].onkeypress = function(e) {\n    e = e || event;\n\n    if (e.ctrlKey || e.altKey || e.metaKey) return;\n\n    var chr = getChar(e);\n\n    // с null надо осторожно в неравенствах, т.к. например null >= '0' => true!\n    // на всякий случай лучше вынести проверку chr == null отдельно\n    if (chr == null) return;\n\n    if (chr < '0' || chr > '9') {\n      return false;\n    }\n  }\n\n  function getChar(event) {\n    if (event.which == null) {\n      if (event.keyCode < 32) return null;\n      return String.fromCharCode(event.keyCode) // IE\n    }\n    if (event.which != 0 && event.charCode != 0) {\n      if (event.which < 32) return null;\n      return String.fromCharCode(event.which) // остальные\n    }\n    return null; // специальная клавиша\n  }\n<\/script>`</script><code-toolbar- iframe="550"><a id="run_1" title="показать" data-code_run="0"></a><a id="task_1" data-code_edit="?" style="display:none"></a><a id="answer_1" title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example><p><a data-click="answer_1">Открыть решение в песочнице.</a></p></task-answer></task-answer-ext></task-content><task-content><h3><a href="#15" name="15">Отследить одновременное нажатие</a><task-open hover-style="" data-show_task="" title="Открыть задачу"></task-open></h3><span title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 3</span><p>Создайте функцию <code>runOnKeys(func, code1, code2, ... code_n)</code>, которая запускает <code>func</code> при одновременном нажатии клавиш со скан-кодами <code>code1</code>, <code>code2</code>, …, <code>code_n</code>.</p><p>Например, код ниже выведет <code>alert</code> при одновременном нажатии клавиш <code>"Q"</code> и <code>"W"</code> (в любом регистре, в любой раскладке)</p><code-example><script>`runOnKeys(\n  function() { alert("Привет!") },\n  "Q".charCodeAt(0),\n  "W".charCodeAt(0)\n);`</script></code-example><p><a data-click="new_2">Демо в новом окне</a></p><button-answer data-toggle_answer="" style="">решение</button-answer><task-answer-ext><button-answer-ext data-toggle_answer_ext="" style="">Ход решения</button-answer-ext><task-answer><close- title="закрыть" data-close_answer=""></close-><h4>Ход решения</h4><ul><li>Функция <code>runOnKeys</code> – с переменным числом аргументов. Для их получения используйте <code>arguments</code>.</li><li>Используйте два обработчика: <code>document.onkeydown</code> и <code>document.onkeyup</code>. Первый отмечает нажатие клавиши в объекте <code>pressed = {}</code>, устанавливая <code>pressed[keyCode] = true</code>, а второй – удаляет это свойство. Если все клавиши с кодами из <code>arguments</code> нажаты – запускайте <code>func</code>.</li><li>Возникнет проблема с повторным нажатием сочетания клавиш после <code>alert</code>, решите её.</li></ul></task-answer><button-answer-ext data-toggle_answer_ext="" style="">Решение</button-answer-ext><task-answer><close- title="закрыть" data-close_answer=""></close-><h4>Решение</h4><code-example><script>`<p>Нажмите одновременно "Q" и "W" (в любой раскладке).</p>\n\n<script>\n  function runOnKeys(func) {\n    var codes = [].slice.call(arguments, 1);\n\n    var pressed = {};\n\n    document.onkeydown = function(e) {\n      e = e || window.event;\n\n      pressed[e.keyCode] = true;\n\n      for (var i = 0; i < codes.length; i++) { // проверить, все ли клавиши нажаты\n        if (!pressed[codes[i]]) {\n          return;\n        }\n      }\n      // во время показа alert, если посетитель отпустит клавиши - не возникнет keyup\n      // при этом JavaScript "пропустит" факт отпускания клавиш, а pressed[keyCode] останется true\n      // чтобы избежать "залипания" клавиши -- обнуляем статус всех клавиш, пусть нажимает всё заново\n      pressed = {};\n\n      func();\n    };\n\n    document.onkeyup = function(e) {\n      e = e || window.event;\n      delete pressed[e.keyCode];\n    };\n  }\n\n  runOnKeys(\n    function() {\n      alert("Привет!")\n    },\n    "Q".charCodeAt(0),\n    "W".charCodeAt(0)\n  );\n<\/script>`</script><code-toolbar- iframe="630"><a id="run_2" title="показать" data-code_run="0"></a><a id="new_2" data-new_window="code" style="display:none"></a><a id="answer_2" title="открыть в песочнице" data-code_edit=""></a></code-toolbar-></code-example><p><a data-click="answer_2">Открыть решение в песочнице.</a></p></task-answer></task-answer-ext></task-content><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>! function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||screen.width<1024||"bannerBottomDisabled" in localStorage||(localStorage.bannerBottomShownCount||(localStorage.bannerBottomShownCount=1),document.querySelector(".banner-bottom").style.display="block")}();</script><nav-book data-tooltips="Прокрутка: событие scroll; Загрузка документа: DOMContentLoaded, load, beforeunload, unload"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url="https:\/\/learn.javascript.ru\/keyboard-events",disqus_identifier="keyboard-events",disqus_title="\u041a\u043b\u0430\u0432\u0438\u0430\u0442\u0443\u0440\u0430: keyup, keydown, keypress";</script></page-content></main>