<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="98">Документ, события, интерфейсы</a><arrow-next></arrow-next><a data-load_page="140">Формы, элементы управления</a></nav-up><h1>Изменение: change, input, cut, copy, paste</h1><p>На элементах формы происходят события клавиатуры и мыши, но есть и несколько других, особенных событий.</p><h2><a name="0" href="#0">Событие change</a></h2><p>Событие <a href="http://www.w3.org/TR/html5/forms.html#event-input-change">change</a> происходит по окончании изменения значения элемента формы, когда это изменение зафиксировано.</p><p>Для текстовых элементов это означает, что событие произойдёт не при каждом вводе, а при потере фокуса.</p><p>Например, пока вы набираете что-то в текстовом поле ниже – события нет. Но как только вы уведёте фокус на другой элемент, например, нажмёте кнопку – произойдет событие <code>onchange</code>.</p><code-example><script>`<input type="text" onchange="alert(this.value)">\n<input type="button" value="Кнопка">`</script><code-toolbar- iframe="40"><a title="показать" data-code_run=""></a><div></div></code-toolbar-></code-example><p>Для остальных же элементов: <code>select</code>, <code>input type=checkbox/radio</code> оно срабатывает сразу при выборе значения.</p><important-warn><h3>Поздний <code>onchange</code> в IE8-</h3><p>В IE8- <code>checkbox/radio</code> при изменении мышью не инициируют событие сразу, а ждут потери фокуса.</p><p>Для того, чтобы видеть изменения <code>checkbox/radio</code> тут же – в IE8- нужно повесить обработчик на событие <code>click</code> (оно произойдет и при изменении значения с клавиатуры) или воспользоваться событием <code>propertychange</code>, описанным далее.</p></important-warn><h2><a name="1" href="#1">Событие input</a></h2><p>Событие <code>input</code> срабатывает <em>тут же</em> при изменении значения текстового элемента и поддерживается всеми браузерами, кроме IE8-.</p><p>В IE9 оно поддерживается частично, а именно – <em>не возникает при удалении символов</em> (как и <code>onpropertychange</code>).</p><p>Пример использования (не работает в IE8-):</p><code-example><script>`<input type="text"> oninput: <span id="result"></span>\n<script>\n  var input = document.body.children[0];\n\n  input.oninput = function() {\n    document.getElementById('result').innerHTML = input.value;\n  };\n<\/script>`</script><code-toolbar- iframe="40"><a title="показать" data-code_run=""></a><div></div></code-toolbar-></code-example><p>В современных браузерах <code>oninput</code> – самое главное событие для работы с элементом формы. Именно его, а не <code>keydown/keypress</code> следует использовать.</p><p>Если бы ещё не проблемы со старыми IE… Впрочем, их можно решить при помощи события <code>propertychange</code>.</p><h2><a name="2" href="#2">IE10-, событие propertychange</a></h2><p>Это событие происходит только в IE10-, при любом изменении свойства. Оно позволяет отлавливать изменение тут же. Оно нестандартное, и его основная область использования – исправление недочётов обработки событий в старых IE.</p><p>Если поставить его на <code>checkbox</code> в IE8-, то получится «правильное» событие <code>change</code>:</p><code-example><script>`<input type="checkbox"> Чекбокс с "onchange", работающим везде одинаково\n<script>\n  var checkbox = document.body.children[0];\n\n  if ("onpropertychange" in checkbox) {\n    // старый IE\nMARK    checkbox.onpropertychange = function() {\nMARK      // проверим имя изменённого свойства\nMARK      if (event.propertyName == "checked") {\nMARK        alert( checkbox.checked );\nMARK      }\nMARK    };\n  } else {\n    // остальные браузеры\n    checkbox.onchange = function() {\n      alert( checkbox.checked );\n    };\n  }\n<\/script>`</script><code-toolbar- iframe="60"><a title="показать" data-code_run="285"></a><div></div></code-toolbar-></code-example><p>Это событие также срабатывает при изменении значения текстового элемента. Поэтому его можно использовать в старых IE вместо <code>oninput</code>.</p><p>К сожалению, в IE9 у него недочёт: оно не срабатывает при удалении символов. Поэтому сочетания <code>onpropertychange</code> + <code>oninput</code> недостаточно, чтобы поймать любое изменение поля в старых IE. Далее мы рассмотрим пример, как это можно сделать иначе.</p><h2><a name="3" href="#3">События cut, copy, paste</a></h2><p>Эти события используются редко. Они происходят при вырезании/вставке/копировании значения.</p><p>К сожалению, кросс-браузерного способа получить данные, которые вставляются/копируются, не существует, поэтому их основное применение – это отмена соответствующей операции.</p><p>Например, вот так:</p><code-example><script>`<input type="text" id="input"> event: <span id="result"></span>\n<script>\n  input.oncut = input.oncopy = input.onpaste = function(event) {\n    result.innerHTML = event.type + '&nbsp' + input.value;\n    return false;\n  };\n<\/script>`</script><code-toolbar- iframe="40"><a title="показать" data-code_run=""></a><div></div></code-toolbar-></code-example><h2><a name="4" href="#4">Пример: поле с контролем СМС</a></h2><p>Как видим, событий несколько и они взаимно дополняют друг друга.</p><p>Посмотрим, как их использовать, на примере.</p><p>Сделаем поле для СМС, рядом с которым должно показываться число символов, обновляющееся при каждом изменении поля.</p><p>Как такое реализовать?</p><p>Событие <code>input</code> идеально решит задачу во всех браузерах, кроме IE9-. Собственно, если IE9- нам не нужен, то на этом можно и остановиться.</p><h3><a name="9" href="#9">IE9-</a></h3><p>В IE8- событие <code>input</code> не поддерживается, но, как мы видели ранее, есть <code>onpropertychange</code>, которое может заменить его.</p><p>Что же касается IE9 – там поддерживаются и <code>input</code> и <code>onpropertychange</code>, но они оба не работают при удалении символов. Поэтому мы будем отслеживать удаление при помощи <code>keyup</code> на <kbd class="shortcut">Delete</kbd> и <kbd class="shortcut">BackSpace</kbd> . А вот удаление командой «вырезать» из меню – сможет отловить лишь <code>oncut</code>.</p><p>Получается вот такая комбинация:</p><code-example><script>`<input type="text" id="sms"> символов: <span id="result"></span>\n<script>\n  function showCount() {\n    result.innerHTML = sms.value.length;\n  }\n\n  sms.onkeyup = sms.oninput = showCount;\n  sms.onpropertychange = function() {\n    if (event.propertyName == "value") showCount();\n  }\n  sms.oncut = function() {\n    setTimeout(showCount, 0); // на момент oncut значение еще старое\n  };\n<\/script>`</script><code-toolbar iframe="60"></code-toolbar></code-example><p>Здесь мы добавили вызов <code>showCount</code> на все события, которые могут приводить к изменению значения. Да, иногда изменение будет обрабатываться несколько раз, но зато с гарантией. А лишние вызовы легко убрать, например, при помощи <code>throttle</code>-декоратора, описанного в задаче <a data-load_page="66-9">Тормозилка</a>.</p><p><strong>Есть и совсем другой простой, но действенный вариант: через <code>setInterval</code> регулярно проверять значение и, если оно слишком длинное, обрезать его.</strong></p><p>Чтобы сэкономить ресурсы браузера, мы можем начинать отслеживание по <code>onfocus</code>, а прекращать – по <code>onblur</code>, вот так:</p><code-example><script>`<input type="text" id="sms"> символов: <span id="result"></span>\n\n<script>\n  var timerId;\n\n  sms.onfocus = function() {\n\n    var lastValue = sms.value;\n    timerId = setInterval(function() {\n      if (sms.value != lastValue) {\n        showCount();\n        lastValue = sms.value;\n      }\n    }, 20);\n  };\n\n  sms.onblur = function() {\n    clearInterval(timerId);\n  };\n\n  function showCount() {\n    result.innerHTML = sms.value.length;\n  }\n<\/script>`</script><code-toolbar- iframe="60"><a title="показать" data-code_run="300"></a><div></div></code-toolbar-></code-example><p>Обратим внимание – весь этот «танец с бубном» нужен только для поддержки IE8-, в которых не поддерживается <code>oninput</code> и IE9, где <code>oninput</code> не работает при удалении.</p><h2><a name="5" href="#5">Итого</a></h2><p>События изменения данных:</p><table><thead><tr><th>Событие</th><th>Описание</th><th>Особенности</th></tr></thead><tbody><tr><td><code>change</code></td><td>Изменение значения любого элемента формы. Для текстовых элементов срабатывает при потере фокуса.</td><td>В IE8- на чекбоксах ждет потери фокуса, поэтому для мгновенной реакции ставят также <code>onclick</code>-обработчик или <code>onpropertychange</code>.</td></tr><tr><td><code>input</code></td><td>Событие срабатывает только на текстовых элементах. Оно не ждет потери фокуса, в отличие от <code>change</code>.</td><td>В IE8- не поддерживается, в IE9 не работает при удалении символов.</td></tr><tr><td><code>propertychange</code></td><td>Только для IE10-. Универсальное событие для отслеживания изменения свойств элементов. Имя изменённого свойства содержится в <code>event.propertyName</code>. Используют для мгновенной реакции на изменение значения в старых IE.</td><td>В IE9 не срабатывает при удалении символов.</td></tr><tr><td><code>cut/copy/paste</code></td><td>Срабатывают при вставке/копировании/удалении текста. Если в их обработчиках отменить действие браузера, то вставки/копирования/удаления не произойдёт.</td><td>Вставляемое значение получить нельзя: на момент срабатывания события в элементе всё ещё <em>старое</em> значение, а новое недоступно.</td></tr></tbody></table><p>Ещё особенность: в IE8- события <code>change</code>, <code>propertychange</code>, <code>cut</code> и аналогичные не всплывают. То есть, обработчики нужно назначать на сам элемент, без делегирования.</p><h2 id="tasks"><a href="#6" name="6">Задачи (1)</a></h2><task-content><h3><a href="#10" name="10">Автовычисление процентов по вкладу</a><task-open hover-style="" data-show_task="" title="Открыть задачу"></task-open></h3><span title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span><p>Создайте интерфейс для автоматического вычисления процентов по вкладу.</p><p>Ставка фиксирована: 12% годовых. При включённом поле «капитализация» – проценты приплюсовываются к сумме вклада каждый месяц (<a href="http://damoney.ru/finance/slozniy-procent.php">сложный процент</a>).</p><p>Пример:</p><style>#capitalization{font-family:serif;color:black;}#capitalization tr,#capitalization th{border:none}</style><figure-><code-toolbar-><a id="answer_1" data-code_edit="" style="display:none"></a><a id="new_1" title="открыть в новом окне" data-new_window=""></a><a data-code_edit="?" title="открыть в песочнице" id="task_1"></a></code-toolbar-><div id="capitalization"><style>#capitalization{margin:10px;}#capitalization tr,#capitalization th{border:none} #capitalization td input,#capitalization td select{width:150px}#diagram td{vertical-align:bottom;text-align:center;padding:10px}#diagram div{margin:auto}</style>Калькулятор процентов, из расчёта 12% годовых.<form name="calculator"><table><tbody><tr><td>Сумма</td><td><input name="money" value="10000"></td></tr><tr><td>Срок в месяцах</td><td><select name="months"><option value="3">3 (минимум)</option><option value="6">6 (полгода)</option><option value="12" selected="">12 (год)</option><option value="18">18 (1.5 года)</option><option value="24">24 (2 года)</option><option value="30">30 (2.5 года)</option><option value="36">36 (3 года)</option></select></td></tr><tr><td>С капитализацией</td><td><input name="capitalization" type="checkbox"></td></tr></tbody></table></form><table id="diagram"><tbody><tr><th>Было:</th><th>Станет:</th></tr><tr><th id="money-before">10000</th><th id="money-after">11200</th></tr><tr><td><div style="background:red;width:40px;height:100px"></div></td><td><div style="background: green; width: 40px; height: 112px;" id="height-after"></div></td></tr></tbody></table></div><script> /* event.type должен быть keypress */ function getChar(event){if (event.which == null){if (event.keyCode<32) return null;return String.fromCharCode(event.keyCode);/* IE */}if (event.which != 0&&event.charCode != 0){if (event.which<32) return null;return String.fromCharCode(event.which);/* остальные */}return null;/* специальная клавиша */}var form=document.forms.calculator;var moneyElem=form.elements.money;moneyElem.onkeypress=function(e){e=e||event;var chr=getChar(e);if (e.ctrlKey||e.altKey||chr == null) return;/* специальная клавиша */ if (chr<'0'||chr>'9') return false;};/* клавиатура,вставить/вырезать клавиатурой */ moneyElem.onkeyup=calculate;moneyElem.oninput=calculate;/* любые действия,кроме IE. В IE9 также работает,кроме удаления */ moneyElem.onpropertychange=function(){/* для IE8- изменение значения,кроме удаления */ event.propertyName == "value"&&calculate();};var capitalizationElem=form.elements.capitalization;capitalizationElem.onclick=calculate;var monthsElem=form.elements.months;monthsElem.onchange=calculate;function calculate(){var sum=+moneyElem.value;if (!sum) return;var monthlyIncrease=0.01;if (!capitalizationElem.checked){sum=sum * (1+monthlyIncrease * monthsElem.value);}else{for (var i=0;i<monthsElem.value;i++){/* 1000 1010 1020.1 */ sum=sum * (1+monthlyIncrease);}} sum=Math.round(sum);var height=sum/moneyElem.value * 100+'px';document.getElementById('height-after').style.height=height;document.getElementById('money-before').innerHTML=moneyElem.value;document.getElementById('money-after').innerHTML=sum;}calculate();</script></figure-><p>Технические требования:</p><ul><li>В поле с суммой должно быть нельзя ввести не-цифру. При этом пусть в нём работают специальные клавиши и сочетания Ctrl-X/Ctrl-V.</li><li>Изменения в форме отражаются в результатах сразу.</li></ul><p><a data-click="task_1">Открыть песочницу для задачи.</a></p><button-answer data-toggle_answer="" style="">решение</button-answer><task-answer><close- title="закрыть" data-close_answer=""></close-><p>Алгоритм решения такой.</p><p>Только численный ввод в поле с суммой разрешаем, повесив обработчик на <code>keypress</code>.</p><p>Отслеживаем события изменения для перевычисления результатов:</p><ul><li>На <code>input</code>: событие <code>input</code> и дополнительно <code>propertychange/keyup</code> для совместимости со старыми IE.</li><li>На <code>checkbox</code>: событие <code>click</code> вместо <code>change</code> для совместимости с IE8-.</li><li>На <code>select</code>: событие <code>change</code>.</li></ul><p><a data-click="answer_1">Открыть решение в песочнице.</a></p></task-answer></task-content><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>! function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||screen.width<1024||"bannerBottomDisabled" in localStorage||(localStorage.bannerBottomShownCount||(localStorage.bannerBottomShownCount=1),document.querySelector(".banner-bottom").style.display="block")}();</script><nav-book data-tooltips="Фокусировка: focus/blur; Формы: отправка, событие и метод submit"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url="https:\/\/learn.javascript.ru\/events-change",disqus_identifier="events-change",disqus_title="\u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u0435: change, input, cut, copy, paste";</script></page-content></main>