<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="180">Оптимизация</a></nav-up><h1>Улучшаем сжатие кода</h1><p>Здесь мы обсудим разные приёмы, которые используются, чтобы улучшить сжатие кода.</p><h2><a name="0" href="#0">Больше локальных переменных</a></h2><p>Например, код jQuery обёрнут в  функцию, запускаемую «на месте».</p><code-example><script>`(function(window, undefined) {\n  // ...\n  var jQuery = ...\n\n  window.jQuery = jQuery; // сделать переменную глобальной\n\n})(window);`</script></code-example><p>Переменные <code>window</code> и <code>undefined</code> стали локальными. Это позволит сжимателю заменить их на более короткие.</p><h2><a name="1" href="#1">ООП без прототипов</a></h2><p>Приватные переменные будут сжаты и заинлайнены.</p><p>Например, этот код хорошо сожмётся:</p><code-example><script>`function User(firstName, lastName) {\n  var fullName = firstName + '&nbsp' + lastName;\n\n  this.sayHi = function() {\n    showMessage(fullName);\n  }\n\n  function showMessage(msg) {\n    alert( '**' + msg + '**' );\n  }\n}`</script></code-example><p>…А этот – плохо:</p><code-example><script>`function User(firstName, lastName) {\n  this._firstName = firstName;\n  this._lastName = lastName;\n}\n\nUser.prototype.sayHi = function() {\n  this._showMessage(this._fullName);\n}\n\nUser.prototype._showMessage = function(msg) {\n  alert( '**' + msg + '**' );\n}`</script></code-example><p>Сжимаются только локальные переменные, свойства объектов не сжимаются, поэтому эффект от сжатия для второго кода будет совсем небольшим.</p><p>При этом, конечно, нужно иметь в виду общий стиль ООП проекта, достоинства и недостатки такого подхода.</p><h2><a name="2" href="#2">Сжатие под платформу, define</a></h2><p>Можно делать разные сборки в зависимости от платформы (мобильная/десктоп) и браузера.</p><p>Ведь не секрет, что ряд функций могут быть реализованы по разному, в зависимости от того, поддерживает ли среда выполнения нужную возможность.</p><h3><a name="11" href="#11">Способ 1: локальная переменная</a></h3><p>Проще всего это сделать локальной переменной в модуле:</p><code-example><script>`(function($) {\n\nMARK  /** @const */\nMARK  var platform = 'IE';\n\n  // .....\n\n  if (platform == 'IE') {\n    alert( 'IE' );\n  } else {\n    alert( 'NON-IE' );\n  }\n\n})(jQuery);`</script></code-example><p>Нужное значение директивы можно вставить при подготовке JavaScript к сжатию.</p><p>Сжиматель заинлайнит её и оптимизирует соответствующие IE.</p><h3><a name="12" href="#12">Способ 2: define</a></h3><p>UglifyJS и GCC позволяют задать значение глобальной переменной из командной строки.</p><p>В GCC эта возможность доступна лишь в «продвинутом режиме» работы оптимизатора, который мы рассмотрим далее (он редко используется).</p><p>Удобнее в этом плане устроен UglifyJS. В нём можно указать флаг <code>-d SYMBOL[=VALUE]</code>, который заменит все переменные <code>SYMBOL</code> на указанное значение <code>VALUE</code>. Если <code>VALUE</code> не указано, то оно считается равным <code>true</code>.</p><p>Флаг не работает, если переменная определена явно.</p><p>Например, рассмотрим код:</p><code-example><script>`// my.js\nif (isIE) {\n  alert( "Привет от IE" );\n} else {\n  alert( "Не IE :)" );\n}`</script></code-example><p>Сжатие вызовом <code>uglifyjs -d isIE my.js</code> даст:</p><code-example><script>`alert( "Привет от IE" );`</script></code-example><p>…Ну а чтобы код работал в обычном окружении, нужно определить в нём значение переменной по умолчанию. Это обычно делается в каком-то другом файле (на весь проект), так как если объявить <code>var isIE</code> в этом, то флаг <code>-d isIE</code> не сработает.</p><p>Но можно и «хакнуть» сжиматель, объявив переменную так:</p><code-example><script>`// объявит переменную при отсутствии сжатия\n// при сжатии не повредит\nwindow.isIE = window.isIE || getBrowserVersion();`</script></code-example><h2><a name="3" href="#3">Убираем вызовы console.*</a></h2><p>Минификатор имеет в своём распоряжении дерево кода и может удалить ненужные вызовы.</p><p>Для UglifyJS это делают опции компилятора:</p><ul><li><code>drop_debugger</code> – убирает вызовы <code>debugger</code>.</li><li><code>drop_console</code> – убирает вызовы <code>console.*</code>.</li></ul><p>Можно написать и дополнительную функцию преобразования, которая убирает другие вызовы, например для <code>log.*</code>:</p><code-example><script>`var uglify = require('uglify-js');\nvar pro = uglify.uglify;\n\nfunction ast_squeeze_console(ast) {\n  var w = pro.ast_walker(),\n    walk = w.walk,\n    scope;\n  return w.with_walkers({\n    "stat": function(stmt) {\n      if (stmt[0] === "call" && stmt[1][0] == "dot" && stmt[1][1] instanceof Array && stmt[1][1][0] == 'name' && stmt[1][1][1] == "log") {\n        return ["block"];\n      }\n      return ["stat", walk(stmt)];\n    },\n    "call": function(expr, args) {\n      if (expr[0] == "dot" && expr[1] instanceof Array && expr[1][0] == 'name' && expr[1][1] == "console") {\n        return ["atom", "0"];\n      }\n    }\n  }, function() {\n    return walk(ast);\n  });\n};`</script></code-example><p>Эту функцию следует вызвать на результате <code>parse</code>, и она пройдётся по дереву и удалит все вызовы <code>log.*</code>.</p><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>!function () { /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || screen.width < 1024 || "bannerBottomDisabled" in localStorage || (localStorage.bannerBottomShownCount || (localStorage.bannerBottomShownCount = 1), document.querySelector(".banner-bottom").style.display = "block") }();</script><nav-book data-tooltips="Как работают сжиматели JavaScript; Утечки памяти"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url = "https:\/\/learn.javascript.ru\/better-minification", disqus_identifier = "better-minification", disqus_title = "\u0423\u043b\u0443\u0447\u0448\u0430\u0435\u043c \u0441\u0436\u0430\u0442\u0438\u0435 \u043a\u043e\u0434\u0430";</script></page-content></main>