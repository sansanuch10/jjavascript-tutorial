<main><page-content><nav-up><home- data-load_page="0" hover-style=""></home-><arrow-next></arrow-next><a data-load_page="180">Оптимизация</a></nav-up><h1>GCC: интеграция с Google Closure Library</h1><p>Google Closure Compiler содержит ряд специальных возможностей для интеграции с Google Closure Library.</p><p>Здесь важны две вещи.</p><ol><li>Для их использования возможно использовать минимум от Google Closure Library. Например, взять одну или несколько функций из библиотеки.</li><li>GCC – расширяемый компилятор, можно добавить к нему свои «фазы оптимизации» для интеграции с другими инструментами и фреймворками.</li></ol><p>Интеграция с Google Closure Library подключается флагом <code>–process_closure_primitives</code>, который по умолчанию установлен в <code>true</code>. То есть, она включена по умолчанию.</p><p>Этот флаг запускает специальный проход компилятора, описанный классом <code>ProcessClosurePrimitives</code> и подключает дополнительную проверку типов <code>ClosureReverseAbstractInterpreter</code>.</p><p>Мы рассмотрим все действия, которые при этом происходят, а также некоторые опции, которые безопасным образом используют символы Google Closure Library  без объявления флага.</p><h2><a name="0" href="#0">Преобразование основных символов</a></h2><p>Следующие действия описаны в классе <code>ProcessClosurePrimitives</code>.</p><h3><a name="3" href="#3">Замена константы <code>COMPILED</code></a></h3><p>В Google Closure Library есть переменная:</p><code-example><script>`/**\nCOMMENT * @define {boolean} ...\n */\nvar COMPILED = false;`</script></code-example><p>Проход <code>ProcessClosurePrimitives</code> переопределяет ее в <code>true</code> и использует это при оптимизациях, удаляя ветки кода, не предназначены для запуска на production.</p><p>Такие функции существуют, например, в ядре Google Closure Library. К ним в первую очередь относятся вызовы, предназначенные для сборки и проверки зависимостей. Они содержат код, обрамленный проверкой <code>COMPILED</code>, например:</p><code-example><script>`goog.require = function(rule) {\n  // ...\n  if (!COMPILED) {\n    // основное тело функции\n  }\n}`</script></code-example><p>Аналогично может поступить и любой скрипт, даже без использования Google Closure Library:</p><code-example><script>`/** @define {boolean} */\nvar COMPILED = false\n\nFramework = {}\n\nFramework.sayCompiled = function() {\n  if (!COMPILED) {\n    alert("Not compressed")\n  } else {\n    alert("Compressed")\n  }\n}`</script></code-example><p>Для того, чтобы сработало, нужно сжать в продвинутом режиме:</p><code-example><script>`Framework = {};\nFramework.sayCompiled = Framework.a = function() {\n  alert( "Compressed" );\n};`</script></code-example><p>Компилятор переопределил <code>COMPILED</code> в <code>true</code> и произвел соответствующие оптимизации.</p><h3><a name="4" href="#4">Автоподстановка локали</a></h3><p>В Google Closure Compiler есть внутренняя опция <code>locale</code></p><p>Эта опция переопределяет переменную <code>goog.LOCALE</code> на установленную при компиляции.</p><p>Для использования опции <code>locale</code>, на момент написания статьи, ее нужно задать в Java коде компилятора, т.к. соответствующего флага нет.</p><p>Как и <code>COMPILED</code>, константу <code>goog.LOCALE</code> можно использовать в своем коде без библиотеки Google Closure Library.</p><h3><a name="5" href="#5">Проверка зависимостей</a></h3><p>Директивы <code>goog.provide</code>, <code>goog.require</code>, <code>goog.addDependency</code> обрабатываются особым образом.</p><p>Все зависимости проверяются, а сами директивы проверки – удаляются из сжатого файла.</p><h3><a name="6" href="#6">Экспорт символов</a></h3><p>Вызов <code>goog.exportSymbol</code> задаёт экспорт символа.</p><p>Если подробнее, то код <code>goog.exportSymbol(„a“,myVar)</code> эквивалентен<code>window['a'] = myVar</code>.</p><h3><a name="7" href="#7">Автозамена классов CSS</a></h3><p>Google Closure Library умеет преобразовывать классы CSS на более короткие по списку, который задаётся при помощи <code>goog.setCssNameMapping</code>.</p><p>Например, следующая функция задает такой список.</p><code-example><script>`goog.setCssNameMapping({\n   "goog-menu": "a",\n   "goog-menu-disabled": "a-b",\n   "CSS_LOGO": "b",\n   "hidden": "c"\n });`</script></code-example><p>Тогда следующий вызов преобразуется в «a a-b»:</p><code-example><script>`goog.getCssName('goog-menu') + '&nbsp' + goog.getCssName('goog-menu', 'disabled')`</script></code-example><p>Google Closure Compiler производит соответствующие преобразования в сжатом файле и удаляет вызов <code>setCssNameMapping</code> из кода.</p><p>Чтобы это сжатие работало, в HTML/CSS классы тоже должны сжиматься. По всей видимости, в приложениях Google это и происходит, но соответствующие инструменты закрыты от публики.</p><h3><a name="8" href="#8">Генерация списка экстернов</a></h3><p>При объявлении внутренней опции <code>externExportsPath</code>, содержащей путь к файлу, в этот файл будут записаны все экспорты, описанные через <code>goog.exportSymbol</code>/<code>goog.exportProperty</code>.</p><p>В дальнейшем этот файл может быть использован как список экстернов для компиляции.</p><p>Эта опция может быть полезна для создания внешних библиотек, распространяемых со списком экстернов.</p><p>Для её использования нужна своя обёртка вокруг компилятора на Java. Соответствующий проход компилятора описан в классе <code>ExternExportsPass</code>.</p><h3><a name="9" href="#9">Проверка типов</a></h3><p>В Google Closure Library есть ряд функций для проверки типов. Например: <code>goog.isArray</code>, <code>goog.isString</code>, <code>goog.isNumber</code>, <code>goog.isDef</code> и т.п.</p><p>Компилятор использует их для проверки типов, более подробно см. <a href="/gcc-check-types">GCC: статическая проверка типов</a></p><p>Эта логика описана в классе <code>ClosureReverseAbstractInterpreter</code>. Названия функций, определяющих типы, жестко прописаны в Java-коде, поменять их на свои без модификации исходников нельзя.</p><h3><a name="10" href="#10">Автогенерация экспортов из аннотаций</a></h3><p>Для этого в Google Closure Compiler есть внутренняя опция <code>generateExports</code>.</p><p>Эта недокументированная опция добавляет проход компилятора, описанный классом <code>GenerateExports</code>.</p><p>Он читает аннотации <code>@export</code> и создает из них экспортирующие вызовы <code>goog.exportSymbol/exportProperty</code>. Название экспортирующих функций находится в классе соглашений кодирования, каким по умолчанию является <code>GoogleCodingConvention</code>.</p><p>Например:</p><code-example><script>`/** @export */\nfunction Widget() {}\n  /** @export */\nWidget.prototype.hide = function() {\n  this.elem.style.display = 'none'\n}`</script></code-example><p>После компиляции в продвинутом режиме:</p><code-example><script>`function a() {}\ngoog.d("Widget", a);\na.prototype.a = function() {\n  this.b.style.display = "none"\n};\ngoog.c(a.prototype, "hide", a.prototype.a);`</script></code-example><p>Свойства благополучно экспортированы. Удобно.</p><h3><a name="11" href="#11">Резюме</a></h3><p>Google Closure Compiler содержит дополнительные фичи, облегчающие интеграцию с Google Closure Library. Некоторые из них весьма полезны, но требуют создания своего Java-файла, который ставит внутренние опции.</p><p>При обработке символов компилятор не смотрит, подключена ли библиотека, он находит обрабатывает их просто по именам. Поэтому вы можете использовать свою реализацию соответствующих функций.</p><p>Google Closure Compiler можно легко расширить, добавив свои опции и проходы оптимизатора, для интеграции с вашими инструментами.</p><banner-bottom class="banner-bottom" style="display: block;"></banner-bottom><script>!function () { /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || screen.width < 1024 || "bannerBottomDisabled" in localStorage || (localStorage.bannerBottomShownCount || (localStorage.bannerBottomShownCount = 1), document.querySelector(".banner-bottom").style.display = "block") }();</script><nav-book data-tooltips="GCC: статическая проверка типов; Окна и Фреймы"></nav-book><share-map><share-></share-><map-button hover-style="" data-load_page="l"></map-button></share-map><comments- id="comments"></comments-><div id="disqus_thread"></div><script>disqus_url = "https:\/\/learn.javascript.ru\/gcc-closure-library", disqus_identifier = "gcc-closure-library", disqus_title = "GCC: \u0438\u043d\u0442\u0435\u0433\u0440\u0430\u0446\u0438\u044f \u0441 Google Closure Library";</script></page-content></main>